

## **Маршрутизация на основе политик (PBR)**

### Цель:

Цель:

Настроить политику маршрутизации в офисе пгт. Чокурдах. Распределить трафик между 2 линками.

В этой самостоятельной работе будет выполнены следующие цели:

1. Необходимо настроить политику маршрутизации для сетей офиса
2. Распределить трафик между двумя линками с провайдером
3. Настроить отслеживание линка через технологию IP SLA
4. Выполнить настройку для офиса Лабытнанги маршрута по-умолчанию
5. План работы и изменения зафиксировать в документации

### Ход выполнения:

Документация оформлена на github, использован markdown.
Для выполнения лабораторной работы использовался эмулятор EVE-NG, терминал Gnome 3.38.


#### 1. Документирование адресного пространства для лабораторного стенда.

#### 1.1 Общий план адресации:

Таблица 1

| Используемые сети: | Тип  | Описание                                                     | Сети           |
| ------------------ | ---- | ------------------------------------------------------------ | -------------- |
|                    | ipv4 | используется для Point-to-Point соединений                   | 10.64.0.0/10   |
|                    | ipv4 | используется для интерфейсов Loopback's.                     | 192.168.0.0/16 |
|                    | ipv4 | используется для управления устройствами                     | 172.22.0.0/16  |
|                    | ipv4 | Пользовательские подсети                                     | 10.0.0.0/8     |
|                    | ipv6 | сеть выделенная провайдером. В подразделениях используются сети с префиксом /64. | 2001:AAAA::/48 |
|                    | ipv6 | сеть для адресов link-local                                  | FE80::/10      |

Описание сетей проекта по всем территориальным подразделениям находится в [Таблице (subnet)](https://docs.google.com/spreadsheets/d/1sV0p-q8V7yGR3Pjk1xMUrwc2siTIBcI2daprLvBshPI/edit?usp=sharing) размещенной в docs.google.com

#### 1.2 Таблица выделенных подсетей для использования в данной работе.

Таблица 2

| Расположение | AS    | IPv4 сеть        | Родительская сеть | IPv6 сеть                  | Родительская сеть     | Описание               |
| ------------ | ----- | ---------------- | ----------------- | -------------------------- | --------------------- | ---------------------- |
| `Чокурдах`   |       |                  |                   |                            |                       |                        |
|              |       | `192.168.3.0/24` |                   | `2001:AAAA:BB03:192::/64`  | `2001:AAAA:BB03::/48` | `Loopback's`           |
|              |       | `172.22.3.0/24`  |                   | `2001:AAAA:BB03:172::/64`  | `2001:AAAA:BB03::/48` | `Управление Vlan 10`   |
|              |       | `10.3.0.0/24`    | `10.3.0.0/21`     | `2001:AAAA:BB03:1021::/64` | `2001:AAAA:BB03::/48` | `Пользователи Vlan 11` |
|              |       | `10.3.1.0/24`    | `10.3.0.0/21`     | `2001:AAAA:BB03:1022::/64` | `2001:AAAA:BB03::/48` | `Пользователи Vlan 12` |
| `Лабытнанги` |       |                  |                   |                            |                       |                        |
|              |       | `192.168.4.0/24` |                   | `2001:AAAA:BB04:192::/64`  | `2001:AAAA:BB04::/48` | `Loopback's`           |
| `Триада`     |       |                  |                   |                            |                       |                        |
|              | `520` | `100.67.0.0/31`  | `100.67.0.0/23`   | `2001:AAAA:BB05:100::/64`  | `2001:AAAA:BB05::/48` | `R23e0/2 - R24e0/2`    |
|              | `520` | `100.67.0.2/31`  | `100.67.0.0/23`   | `2001:AAAA:BB05:102::/64`  | `2001:AAAA:BB05::/48` | `R23e0/1 - R25e0/0`    |
|              | `520` | `100.67.0.4/31`  | `100.67.0.0/23`   | `2001:AAAA:BB05:104::/64`  | `2001:AAAA:BB05::/48` | `R24e0/1 - R26e0/0`    |
|              | `520` | `100.67.0.6/31`  | `100.67.0.0/23`   | `2001:AAAA:BB05:106::/64`  | `2001:AAAA:BB05::/48` | `R24e0/3 - R18e0/2`    |
|              | `520` | `100.67.0.8/31`  | `100.67.0.0/23`   | `2001:AAAA:BB05:108::/64`  | `2001:AAAA:BB05::/48` | `R25e0/2 - R26e0/2`    |
|              | `520` | `100.67.0.10/31` | `100.67.0.0/23`   | `2001:AAAA:BB05:110::/64`  | `2001:AAAA:BB05::/48` | `R25e0/3 - R28e0/1`    |
|              | `520` | `100.67.0.12/31` | `100.67.0.0/23`   | `2001:AAAA:BB05:112::/64`  | `2001:AAAA:BB05::/48` | `R25e0/1 - R27e0/0`    |
|              | `520` | `100.67.0.14/31` | `100.67.0.0/23`   | `2001:AAAA:BB05:114::/64`  | `2001:AAAA:BB05::/48` | `R26e0/3 - R18e0/3`    |
|              | `520` | `100.67.0.16/31` | `100.67.0.0/23`   | `2001:AAAA:BB05:116::/64`  | `2001:AAAA:BB05::/48` | `R26e0/1 - R28e0/0`    |
|              | `520` | `192.168.5.0/24` |                   | `2001:AAAA:BB05:192::/64`  | `2001:AAAA:BB05::/48` | `Loopback's`           |

#### 1.3 Таблица IP адресов.

| Расположение | Устройство | Интерфейс    | IPv4 адрес     | Родит. сеть       | IPv6 адрес                     | Родительская сеть          | Описание                   |
| ------------ | ---------- | ------------ | -------------- | ----------------- | ------------------------------ | -------------------------- | -------------------------- |
| `Чокурдах`   |            |              |                |                   |                                |                            |                            |
|              | `R28`      | `Lo0`        | `192.168.3.28` | `192.168.3.28/32` | `2001:AAAA:BB03:192::28/128`   | `2001:AAAA:BB03:192::/64`  | `Loopback R28`             |
|              |            | `e0/0`       | `100.67.0.17`  | `100.67.0.16/31`  | `2001:AAAA:BB05:116::17:E0/64` | `2001:AAAA:BB05:116::/64`  |                            |
|              |            |              |                |                   | `FE80::28:E0`                  | `FE80::/10`                |                            |
|              |            | `e0/1`       | `100.67.0.11`  | `100.67.0.10/31`  | `2001:AAAA:BB05:110::11:E1/64` | `2001:AAAA:BB05:110::/64`  |                            |
|              |            |              |                |                   | `FE80::28:E1`                  | `FE80::/10`                |                            |
|              |            | `e0/2`       | `N/A`          | `N/A`             | `N/A`                          | `N/A`                      |                            |
|              |            | `e0/2.10`    | `172.22.3.1`   | `172.22.3.0/24`   | `2001:AAAA:BB03:172::1/64`     | `2001:AAAA:BB03:172::/64`  | `Управление  Vlan 10`      |
|              |            |              |                |                   | `FE80::28:E210`                | `FE80::/10`                |                            |
|              |            | `e0/2.11`    | `10.3.0.1`     | `10.3.0.0/24`     | `2001:AAAA:BB03:1011::1/64`    | `2001:AAAA:BB03:1011::/64` | `Пользовательский Vlan 11` |
|              |            |              |                |                   | `FE80::28:E211`                | `FE80::/10`                |                            |
|              |            | `e0/2.12`    | `10.3.1.1`     | `10.3.1.0/24`     | `2001:AAAA:BB03:1012::1/64`    | `2001:AAAA:BB03:1012::/64` | `Пользовательский Vlan 12` |
|              |            |              |                |                   | `FE80::28:E212`                | `FE80::/10`                |                            |
|              | `SW29`     | `Int Vlan10` | `172.22.3.29`  | `172.22.3.0/24`   | `2001:AAAA:BB03:172::29с/64`   | `2001:AAAA:BB03:172::/64`  |                            |
|              |            |              |                |                   | `FE80::с29:10`                 | `FE80::/10`                |                            |
|              | `VPC30`    |              | `DHCP`         | `10.3.0.0/24`     | `autoconfig`                   | `2001:AAAA:BB03:1011::/64` |                            |
|              | `VPC31`    |              | `DHCP`         | `10.3.1.0/24`     | `autoconfig`                   | `2001:AAAA:BB03:1012::/64` |                            |
| `Лабытнанги` |            |              |                |                   |                                |                            |                            |
|              | `R27`      | `Lo0`        | `192.168.4.27` | `192.168.4.27/32` | `2001:AAAA:BB04:192::27/128`   | `2001:AAAA:BB04:192::/64`  | `Loopback R27`             |
|              |            | `e0/0`       | `100.67.0.13`  | `100.67.0.12/31`  | `2001:AAAA:BB05:112::13:E0/64` | `2001:AAAA:BB05:112::/64`  |                            |
|              |            |              |                |                   | `FE80::27:E0`                  | `FE80::/10`                |                            |
| `Триада`     |            |              |                |                   |                                |                            |                            |
|              | `R23`      | `Lo0`        | `192.168.5.23` | `192.168.5.23/32` | `2001:AAAA:BB05:192::23/128`   | `2001:AAAA:BB05:192::/64`  | `Loopback R23`             |
|              |            | `e0/0`       | `100.64.0.5`   | `100.64.0.4/31`   | `2001:AAAA:BB00:104::5:E0/64`  | `2001:AAAA:BB00:104::/64`  |                            |
|              |            |              |                |                   | `FE80::23:E0`                  | `FE80::/10`                |                            |
|              |            | `e0/2`       | `100.67.0.0`   | `100.67.0.0/31`   | `2001:AAAA:BB05:100::E2/64`    | `2001:AAAA:BB05:100::/64`  |                            |
|              |            |              |                |                   | `FE80::23:E2`                  | `FE80::/10`                |                            |
|              |            | `e0/1`       | `100.67.0.2`   | `100.67.0.2/31`   | `2001:AAAA:BB05:102::2:E1/64`  | `2001:AAAA:BB05:102::/64`  |                            |
|              |            |              |                |                   | `FE80::23:E1`                  | `FE80::/10`                |                            |
|              | `R24`      | `Lo0`        | `192.168.5.24` | `192.168.5.24/32` | `2001:AAAA:BB05:192::24/128`   | `2001:AAAA:BB05:192::/64`  | `Loopback R24`             |
|              |            | `e0/0`       | `100.68.0.3`   | `100.68.0.2/31`   | `2001:AAAA:BB06:102::3:E0/64`  | `2001:AAAA:BB06:102::/64`  |                            |
|              |            |              |                |                   | `FE80::24:E0`                  | `FE80::/10`                |                            |
|              |            | `e0/2`       | `100.67.0.1`   | `100.67.0.0/31`   | `2001:AAAA:BB05:100::1:E2/64`  | `2001:AAAA:BB05:100::/64`  |                            |
|              |            |              |                |                   | `FE80::24:E2`                  | `FE80::/10`                |                            |
|              |            | `e0/1`       | `100.67.0.4`   | `100.67.0.4/31`   | `2001:AAAA:BB05:104::4:E1/64`  | `2001:AAAA:BB05:104::/64`  |                            |
|              |            |              |                |                   | `FE80::24:E1`                  | `FE80::/10`                |                            |
|              |            | `e0/3`       | `100.67.0.6`   | `100.67.0.6/31`   | `2001:AAAA:BB05:106::6:E3/64`  | `2001:AAAA:BB05:106::/64`  |                            |
|              |            |              |                |                   | `FE80::24:E3`                  | `FE80::/10`                |                            |
|              | `R26`      | `Lo0`        | `192.168.5.26` | `192.168.5.26/32` | `2001:AAAA:BB05:192::26/128`   | `2001:AAAA:BB05:192::/64`  | `Loopback R26`             |
|              |            | `e0/0`       | `100.67.0.5`   | `100.67.0.4/31`   | `2001:AAAA:BB05:104::5:E0/64`  | `2001:AAAA:BB05:104::/64`  |                            |
|              |            |              |                |                   | `FE80::26:E0`                  | `FE80::/10`                |                            |
|              |            | `e0/3`       | `100.67.0.14`  | `100.67.0.14/31`  | `2001:AAAA:BB05:114::14:E3/64` | `2001:AAAA:BB05:114::/64`  |                            |
|              |            |              |                |                   | `FE80::26:E3`                  | `FE80::/10`                |                            |
|              |            | `e0/1`       | `100.67.0.16`  | `100.67.0.16/31`  | `2001:AAAA:BB05:116::16:E1/64` | `2001:AAAA:BB05:116::/64`  |                            |
|              |            |              |                |                   | `FE80::26:E1`                  | `FE80::/10`                |                            |
|              |            | `e0/2`       | `100.67.0.9`   | `100.67.0.8/31`   | `2001:AAAA:BB05:108::9:E2/64`  | `2001:AAAA:BB05:108::/64`  |                            |
|              |            |              |                |                   | `FE80::26:E2`                  | `FE80::/10`                |                            |
|              | `R25`      | `Lo0`        | `192.168.5.25` | `192.168.5.25/32` | `2001:AAAA:BB05:192::25/128`   | `2001:AAAA:BB05:192::/64`  | `Loopback R25`             |
|              |            | `e0/0`       | `100.67.0.3`   | `100.67.0.2/31`   | `2001:AAAA:BB05:102::3:E0/64`  | `2001:AAAA:BB05:102::/64`  |                            |
|              |            |              |                |                   | `FE80::25:E0`                  | `FE80::/10`                |                            |
|              |            | `e0/2`       | `100.67.0.8`   | `100.67.0.8/31`   | `2001:AAAA:BB05:108::8:E2/64`  | `2001:AAAA:BB05:108::/64`  |                            |
|              |            |              |                |                   | `FE80::25:E2`                  | `FE80::/10`                |                            |
|              |            | `e0/3`       | `100.67.0.10`  | `100.67.0.10/31`  | `2001:AAAA:BB05:110::10:E3/6`  | `2001:AAAA:BB05:110::/64`  |                            |
|              |            |              |                |                   | `FE80::25:E3`                  | `FE80::/10`                |                            |
|              |            | `e0/1`       | `100.67.0.12`  | `100.67.0.12/31`  | `2001:AAAA:BB05:112::12:E1/64` | `2001:AAAA:BB05:112::/64`  |                            |
|              |            |              |                |                   | FE80::25:E1                    | FE80::/10                  |                            |

#### 2. Настройка сетевого оборудования.

#### 2.1 Настройка маршрута по умолчанию для офиса Лабытнанги.

В данном разделе настроил маршрут по умолчанию на R27. 


```
conf t
!
ip route 0.0.0.0 0.0.0.0 100.67.0.12 name R25_e0/1
ipv6 route ::/0 2001:AAAA:BB05:112::12:E1 name R25_e0/1
```
Настройка маршрутизатора R27 находятся в папке [cfg](https://github.com/darkmikos/otus.ru/tree/master/lab10/cfg).


#### 2.2 Настройка маршрута для сетей офиса Чокурдах на маршрутизаторах Триады.

Для доступа с R27 в Лабытнангах до сетей в офисах Чокурдах. Необходимо на маршрутизаторах провайдера Триада R25 и R26 прописать статические маршруты в сторону маршрутизатора в Чокурдах. 

R25:


```
conf t
!
ip route 10.3.0.0 255.255.254.0 100.67.0.11 name toSubnetChokurdah
ip route 10.3.0.0 255.255.254.0 100.67.0.9 113 name toSubnetChokurdahR26
!
ipv6 route 2001:AAAA:BB03::/48 2001:AAAA:BB05:110::11:E1 name toSubnetChokurdah
ipv6 route 2001:AAAA:BB03::/48 2001:AAAA:BB05:108::9:E2 113 name toSubnetChokurdahR26
```
R26:

```
conf t
!
ip route 100.67.0.12 255.255.255.254 100.67.0.8 name toLabytnangi
ip route 10.3.0.0 255.255.254.0 100.67.0.17 name toSubnetChokurdah
!
ipv6 route 2001:AAAA:BB03::/48 2001:AAAA:BB05:116::17:E0 name toChokurdah
ipv6 route 2001:AAAA:BB05:112::/64 2001:AAAA:BB05:108::8:E2 name toLabytnangi
```

Настройка маршрутизатора R25, R26 находятся в папке [cfg](https://github.com/darkmikos/otus.ru/tree/master/lab10/cfg).


#### 2.3 Распределение трафика между двумя линками с провайдером.

Для распределия трафика между двумя интерфейсами подключенными к маршрутизаторам R25, R26 провайдера Триада  необходимо создать access-list и route-map с правилами для подсетей офиса Чокурдах, а также включить правила на субинтерфейсах маршрутизатора R28. 

Создание ACL R28

```
conf t
!
 ip access-list extended ACL-SUBNET11
  permit ip 10.3.0.0 0.0.0.255 any
  exit
 ip access-list extended ACL-SUBNET12
  permit ip 10.3.1.0 0.0.0.255 any
  exit
```

Создание маршрутных карт route-map R28


```
conf t
!
route-map PBR_RULE permit 10
 match ip address ACL-SUBNET11
 set ip next-hop verify-availability 100.67.0.16 10 track 1
 set ip next-hop verify-availability 100.67.0.10 20 track 2
 exit
!
route-map PBR_RULE permit 20
 match ip address ACL-SUBNET12
 set ip next-hop verify-availability 100.67.0.10 10 track 2
 set ip next-hop verify-availability 100.67.0.16 20 track 1
 exit
```

Что бы включить правила route-map необходимо настроить политики на субинтерфейсах R28.


```
conf t
!
interface Ethernet0/2.11
 ip policy route-map PBR_RULE
 exit
interface Ethernet0/2.12
 ip policy route-map PBR_RULE
 exit 
```

Настройка маршрутизатора R28 находятся в папке [cfg](https://github.com/darkmikos/otus.ru/tree/master/lab10/cfg).

#### d. Настройка отслеживания линка через технологию IP SLA.

На данном этапе лабораторной работы наобходимо настроить отслеживание линков с помощью технологии IP SLA. Для этой задачи использовал протокол ICMP. Пинги запускаются каждые 5 секунд с маршрутизатора R28 на ip адреса интерфейсов маршрутизаторов R25 и R26.


```
conf t
!
ip sla 1
 icmp-echo 100.67.0.16 source-ip 100.67.0.17
 frequency 5
exit
ip sla schedule 1 life forever start-time now
!
ip sla 2
 icmp-echo 100.67.0.10 source-ip 100.67.0.11
 frequency 5
exit
ip sla schedule 2 life forever start-time now
!
```


Для связи route-map и ip sla используются track.

```
!
track 1 ip sla 1 reachability
exit
track 2 ip sla 2 reachability
exit
```

Настройка маршрутизатора R28 находятся в папке [cfg](https://github.com/darkmikos/otus.ru/tree/master/lab10/cfg).

Настройки оборудования выполнены. Следующий шаг - проверка выполненных работ.

#### 3. Проверка работоспособности системы.

На персональных компьютерах VPC30, VPC31  IPv4 адреса присваиваются автоматически по средствам DHCP-сервера. DHCP-сервер развернут на маршрутизаторе R28. Конфигурация маршрутизатора R28 находятся в папке [cfg](https://github.com/darkmikos/otus.ru/tree/master/lab10/cfg).

Для проверки прохождения трафика использую ip-адрес роутера R27 - 100.67.0.13. С помощью команды trace 10.5.0.13 -P 1 проведу трассировку маршрута до R27 c компьютеров:

VPC30

```
VPCS> trace 100.67.0.13 -P 1
trace to 100.67.0.13, 8 hops max (ICMP), press Ctrl+C to stop
 1   10.3.0.1   0.884 ms  0.370 ms  0.319 ms
 2   100.67.0.16   0.531 ms  0.400 ms  0.431 ms
 3   100.67.0.8   0.680 ms  0.508 ms  0.468 ms
 4   100.67.0.13   0.974 ms  0.654 ms  0.559 ms
```

VPC31

```
VPCS> trace 100.67.0.13 -P 1
trace to 100.67.0.13, 8 hops max (ICMP), press Ctrl+C to stop
 1   10.3.1.1   0.906 ms  0.824 ms  0.945 ms
 2   100.67.0.10   1.483 ms  1.376 ms  1.304 ms
 3   100.67.0.13   1.654 ms  2.767 ms  3.082 ms
```

Исходя из трасировки маршрутов с VPC30, VPC31 видим, что трафик до R27 разделился на два маршрута.

Теперь проверю будет ли ходить трафик, если будет недоступен интерфейс e0/3 на роутере R25 ip адрес которого 100.67.0.10. 

Для проверки недоступности интрефейса использую эхо-запрос с маршрутизатора  R28 на ip адрес 100.67.0.10

```
R28#ping 100.67.0.10
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 100.67.0.10, timeout is 2 seconds:
.....
Success rate is 0 percent (0/5)
```

Далее повторим команду trace 100.67.0.13 -P 1 с VPC30, VPC31 до R27 c компьютеров VPC30 (рис.4) и  (рис.5).

VPC30

```
VPCS> trace 100.67.0.13 -P 1
trace to 100.67.0.13, 8 hops max (ICMP), press Ctrl+C to stop
 1   10.3.0.1   0.924 ms  1.054 ms  1.150 ms
 2   100.67.0.16   1.601 ms  1.139 ms  1.543 ms
 3   100.67.0.8   1.885 ms  1.641 ms  2.187 ms
 4   100.67.0.13   1.603 ms  4.141 ms  2.350 ms
```

VPC31

```
VPCS> trace 100.67.0.13 -P 1
trace to 100.67.0.13, 8 hops max (ICMP), press Ctrl+C to stop
 1   10.3.1.1   0.884 ms  0.774 ms  0.683 ms
 2   100.67.0.16   1.042 ms  0.785 ms  0.777 ms
 3   100.67.0.8   1.554 ms  1.122 ms  1.310 ms
 4   100.67.0.13   1.882 ms  1.320 ms  1.125 ms
```

Видим, что весь трафик пошел через интерфейс e0/1 маршрутизатора R26. Отслеживание линка через технологию IP SLA работает.

Теперь проведу аналогичные действия и проверю будет ли ходить трафик, если будет недоступен интерфейс e0/1 на роутере R26 ip адрес которого 100.67.0.16. 

Для проверки недоступности интрефейса использую эхо-запрос с маршрутизатора  R28 на ip адрес 100.67.0.16

```
R28#ping 100.67.0.16
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 100.67.0.16, timeout is 2 seconds:
.....
Success rate is 0 percent (0/5)
```

Для проверки прохождения трафика использую ip-адрес роутера R27 - 100.67.0.13. С помощью команды trace 10.5.0.13 -P 1 проведу трассировку маршрута до R27 c компьютеров:

VPC30

```
VPCS> trace 100.67.0.13 -P 1
trace to 100.67.0.13, 8 hops max (ICMP), press Ctrl+C to stop
 1   10.3.0.1   0.652 ms  0.458 ms  0.550 ms
 2   100.67.0.10   0.904 ms  0.839 ms  1.010 ms
 3   100.67.0.13   1.117 ms  1.167 ms  1.161 ms

```

VPC31

```
VPCS> trace 100.67.0.13 -P 1
trace to 100.67.0.13, 8 hops max (ICMP), press Ctrl+C to stop
 1   10.3.1.1   1.310 ms  1.075 ms  0.783 ms
 2   100.67.0.10   1.549 ms  1.064 ms  0.545 ms
 3   100.67.0.13   0.767 ms  0.605 ms  0.583 ms
```

Наблюдаем, что весь трафик пошел через интерфейс e0/3 маршрутизатора R25.

**Из вышеприведенных примеров вижу, что отслеживание линка через технологию IP SLA работает!**



#### 4. Итоговая схема.

На рисунке 1 размещены используемые сети, IPv4 и IPv6 адреса маршрутизаторов, коммутаторов и персональных компьютеров а так же испльзуемые VLAN.

![Рисунок 1](https://github.com/darkmikos/otus.ru/blob/master/lab10/%D1%81onnection_diagram.png)

